<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <title>Koszyk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/site.css" rel="stylesheet">
    <style>
        .basket-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: .5rem .75rem;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            margin-bottom: .5rem;
        }

            .basket-item strong {
                display: block;
            }

        .basket-actions button {
            margin-left: .4rem;
        }

        .basket-empty {
            opacity: .75;
            font-style: italic;
        }

        .warn {
            color: #ffd166;
        }

        .error {
            color: #ff6b6b;
        }
    </style>
</head>
<body>
    <div class="buttons-top-right">
        <button class="winter-button" type="button" data-nav="Index.html">❆ Menu</button>
        <button class="winter-button" type="button" data-nav="Equipment.html">⛷️ Sprzęt</button>
        <details class="user-panel disabled">
            <summary class="winter-button" aria-label="Panel użytkownika">👤 Panel użytkownika</summary>
            <div class="user-panel-menu">
                <button class="winter-button" type="button" data-nav="OrderHistory.html" data-show-when-auth="true">Historia zamówień</button>
                <button class="winter-button" type="button" data-nav="UserData.html" data-show-when-auth="true">Dane użytkownika</button>
                <button class="winter-button" type="button" data-nav="WorkerPanel.html" data-required-roles="worker, admin">Panel pracownika</button>
                <button class="winter-button" type="button" data-nav="AdminPanel.html" data-required-roles="admin">Panel administratora</button>
                <button class="winter-button" type="button" data-nav="AddOrDeleteItem.html" data-required-roles="worker, admin">Dodaj Sprzęt</button>
            </div>
        </details>
        <button class="winter-button" type="button" data-nav="Kontakt.html">📞 Kontakt</button>
        <button class="winter-button" type="button" data-nav="Basket.html">🛒 Koszyk</button>
        <button class="winter-button" type="button" data-logout="true" data-show-when-auth="true">🚪 Wyloguj</button>
        <button class="winter-button" type="button" data-nav="Login.html" data-hide-when-auth="true">🔒 Logowanie</button>
    </div>

    <div class="content-section">
        <div class="frost-effect">
            <h1 class="winter-title">Koszyk</h1>

            <div id="basketItems" class="contact-info"></div>

            <div class="block-actions">
                <button class="winter-button" id="clearBasket">Wyczyść koszyk</button>
            </div>

            <div class="form-box">
                <label>
                    Liczba dni wypożyczenia
                    <input type="number" id="rentDays" min="1" value="1" />
                </label>

                <div class="contact-item">
                    <strong>Suma podstawowa</strong>
                    <div class="contact-value" id="baseTotal">0 zł</div>
                </div>

                <div class="contact-item">
                    <strong>Zniżka łącznie</strong>
                    <div class="contact-value" id="discountPct">0%</div>
                </div>

                <div class="contact-item">
                    <strong>Suma z dniami i zniżką</strong>
                    <div class="contact-value" id="finalTotal">0 zł</div>
                </div>

                <div class="contact-item warn" id="stockWarning" style="display:none"></div>

                <div class="block-actions">
                    <button class="winter-button" id="placeOrder" data-show-when-auth="true">Złóż zamówienie</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/site.js" defer></script>
    <script>
        // Cennik fallback (gdy brak Price w koszyku)
        const priceMap = {
            Skis: { Small: 120, Medium: 130, Large: 140 },
            Helmet: { Any: 35, Universal: 35 },
            Gloves: { Small: 15, Medium: 15, Large: 15 },
            Poles: { Any: 22 },
            Snowboard: { Any: 160 },
            Goggles: { Any: 55, Universal: 55 }
        };

        const basket = JSON.parse(localStorage.getItem('basket') || '[]');

        const qs = sel => document.querySelector(sel);

        const qty = i => {
            const q = Number(i.quantity || i.Qty || i.qty || i.Quantity);
            return (!Number.isFinite(q) || q <= 0) ? 1 : q;
        };

        const name = i =>
            i.name || i.Name || [i.Type || i.type, i.Size || i.size].filter(Boolean).join(' ');

        const price = i => {
            const p = Number(i.Price ?? i.price);
            if (Number.isFinite(p) && p > 0) return p;

            const t = priceMap[(i.Type ?? i.type)];
            if (!t) return0;

            const s = (i.Size ?? i.size);
            return (s && t[s] !== undefined) ? t[s] : (t.Any || 0);
        };

        const baseItemsTotal = () =>
            basket.reduce((s, i) => s + price(i) * qty(i), 0);

        const itemsCount = () =>
            basket.reduce((s, i) => s + qty(i), 0);

        const getDays = () =>
            Math.max(1, parseInt(String(qs('#rentDays').value).replace(',', '.'), 10) || 1);

        const itemsDetail = () =>
            basket.map(i => ({
                Type: (i.Type || i.type || '').toString(),
                Size: (i.Size || i.size || '').toString(),
                Quantity: qty(i),
                EquipmentIds: Array.isArray(i.EquipmentIds || i.equipmentIds)
                    ? (i.EquipmentIds || i.equipmentIds)
                    : []
            }));

        function save() {
            localStorage.setItem('basket', JSON.stringify(basket));
        }

        function renderBasket() {
            const el = qs('#basketItems');

            if (!basket.length) {
                el.innerHTML = '<div class="contact-item">Koszyk jest pusty.</div>';
            } else {
                el.innerHTML = basket
                    .map(i =>
                        `<div class="contact-item">
                                        <strong>${name(i)} × ${qty(i)}</strong>
                                        <div class="contact-value">${(price(i) * qty(i)).toFixed(2)} zł</div>
                                    </div>`
                    )
                    .join('');
            }

            const baseBeforeDiscount = baseItemsTotal() * getDays();
            qs('#baseTotal').textContent = baseBeforeDiscount.toFixed(2) + ' zł';

            preview();
        }

        async function preview() {
            const warn = qs('#stockWarning');
            warn.style.display = 'none';
            warn.textContent = '';

            try {
                const res = await fetch('/api/orders/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        BasePrice: Number(baseItemsTotal().toFixed(2)),
                        Days: getDays(),
                        ItemsCount: itemsCount(),
                        ItemsDetail: itemsDetail()
                    })
                });

                if (!res.ok) throw new Error(await res.text());

                const d = await res.json();
                const pct = Number(d.DiscountPct) || 0;
                const final = Number(d.Price) || 0;

                qs('#discountPct').textContent = Math.round(pct * 100) + '%';
                qs('#finalTotal').textContent = final.toFixed(2) + ' zł';

                const placeBtn = qs('#placeOrder');

                if (d.Error) {
                    placeBtn.disabled = true;
                    warn.style.display = 'block';
                    warn.textContent = d.Error;
                } else {
                    placeBtn.disabled = false;
                }
            } catch (e) {
                /* brak */
            }
        }

        async function placeOrder() {
            try {
                const items = basket.map(i => `${name(i)} x ${qty(i)}`);

                const res = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        Items: items,
                        BasePrice: Number(baseItemsTotal().toFixed(2)),
                        Days: getDays(),
                        ItemsCount: itemsCount(),
                        ItemsDetail: itemsDetail()
                    })
                });

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt || 'Nie można złożyć zamówienia');
                }

                const d = await res.json();

                alert(
                    `Cena: ${(Number(d.Price) || 0).toFixed(2)} zł za ${getDays()} dni, zniżka: ${Math.round((Number(d.DiscountPct) || 0) * 100)}%`
                );

                localStorage.removeItem('basket');
                basket.length = 0;

                renderBasket();
            } catch (e) {
                alert('Błąd zamówienia: ' + e.message);
            }
        }

        qs('#clearBasket').addEventListener('click', () => {
            localStorage.removeItem('basket');
            basket.length = 0;
            renderBasket();
        });

        qs('#placeOrder').addEventListener('click', placeOrder);
        qs('#rentDays').addEventListener('input', () => renderBasket());

        document.addEventListener('DOMContentLoaded', renderBasket);
    </script>
</body>
</html>
