<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="utf-8" />
    <title>Dane użytkownika</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/css/site.css" rel="stylesheet">
</head>

<body>
    <div class="buttons-top-right">
        <button class="winter-button" type="button" data-nav="Index.html">❆ Menu</button>
        <button class="winter-button" type="button" data-nav="Equipment.html">⛷️ Sprzęt</button>

        <details class="user-panel disabled">
            <summary class="winter-button" aria-label="Panel użytkownika">👤 Panel użytkownika</summary>
            <div class="user-panel-menu">
                <button class="winter-button" type="button" data-nav="OrderHistory.html" data-show-when-auth="true">
                    Historia zamówień
                </button>
                <button class="winter-button" type="button" data-nav="UserData.html" data-show-when-auth="true">
                    Dane użytkownika
                </button>
                <button class="winter-button" type="button" data-nav="WorkerPanel.html" data-required-roles="worker, admin">
                    Panel pracownika
                </button>
                <button class="winter-button" type="button" data-nav="AdminPanel.html" data-required-roles="admin">
                    Panel administratora
                </button>
                <button class="winter-button" type="button" data-nav="AddOrDeleteItem.html" data-required-roles="worker, admin">
                    Dodaj Sprzęt
                </button>
            </div>
        </details>

        <button class="winter-button" type="button" data-nav="Kontakt.html">📞 Kontakt</button>
        <button class="winter-button" type="button" data-nav="Basket.html">🛒 Koszyk</button>
        <button class="winter-button" type="button" data-logout="true" data-show-when-auth="true">🚪 Wyloguj</button>
    </div>

    <div class="content-section">
        <div class="frost-effect">
            <h1 class="winter-title">Dane użytkownika</h1>

            <div id="userData" class="contact-info" data-show-when-auth="true">
                <p>Ładowanie danych...</p>
            </div>

            <div class="form-box" id="usernameBox" data-show-when-auth="true" style="margin-top:1rem; display:none;">
                <label>
                    Nowa nazwa użytkownika
                    <input type="text" id="newUserName" minlength="3" maxlength="50" />
                </label>
                <div class="block-actions">
                    <button class="winter-button" id="btnChangeUserName">Zmień nazwę</button>
                    <span id="userMsg" class="msg"></span>
                </div>
            </div>

            <div class="alt-link" data-hide-when-auth="true">
                Aby zobaczyć dane, zaloguj się: <a href="Login.html">Logowanie</a>
            </div>
        </div>
    </div>

    <script src="/js/site.js" defer></script>

    <script>
        async function loadUser() {
            try {
                let res = await fetch('/api/auth/me', { credentials: 'include' });

                if (!res.ok) {
                    res = await fetch('/api/users/me', { credentials: 'include' });
                }
                if (!res.ok) return;

                const u = await res.json();

                const el = document.getElementById('userData');
                const userName = u.userName ?? u.UserName ?? '—';
                const email = u.email ?? u.Email ?? '—';
                const phone = u.phoneNumber ?? u.PhoneNumber ?? '—';
                const firstName = u.first_name ?? u.First_name ?? '—';
                const lastName = u.last_name ?? u.Last_name ?? '—';

                el.innerHTML = `
<div class="contact-item"><strong>Nazwa użytkownika</strong><div class="contact-value">${userName}</div></div>
<div class="contact-item"><strong>Email</strong><div class="contact-value">${email}</div></div>
<div class="contact-item"><strong>Telefon</strong><div class="contact-value">${phone}</div></div>
<div class="contact-item"><strong>Imię</strong><div class="contact-value">${firstName}</div></div>
<div class="contact-item"><strong>Nazwisko</strong><div class="contact-value">${lastName}</div></div>`;

                document.getElementById('usernameBox').style.display = '';
                document.getElementById('newUserName').value = userName;

            } catch { }
        }

        async function changeUserName() {
            const msg = document.getElementById('userMsg');
            msg.className = 'msg';
            msg.textContent = 'Zapisywanie...';

            const newName = document.getElementById('newUserName').value.trim();

            if (!newName) {
                msg.className = 'msg error';
                msg.textContent = 'Podaj nazwę użytkownika';
                return;
            }

            try {
                const res = await fetch('/api/users/me/username', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ UserName: newName })
                });

                const text = await res.text();
                let data = text;

                try {
                    data = JSON.parse(text);
                } catch { }

                if (!res.ok) {
                    throw new Error(typeof data === 'string' ? data : (data.Message || 'Błąd'));
                }

                msg.className = 'msg success';
                msg.textContent = 'Zmieniono nazwę użytkownika';

                await loadUser();

            } catch (e) {
                msg.className = 'msg error';
                msg.textContent = 'Błąd: ' + e.message;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadUser();
            document.getElementById('btnChangeUserName').addEventListener('click', changeUserName);
        });
    </script>

</body>

</html>
