@page "/Equipment.html"
@{
 ViewData["Title"] = "Sprzęt";
}

<link rel="stylesheet" href="/css/equipment.css" />

<h1 class="winter-title">🎿 Sprzęt</h1>
<div class="equipment-slider">
 <button class="winter-button slider-nav" id="prevSlide">◀</button>
 <div class="slide-viewport">
 <div class="slide-track" id="slideTrack"></div>
 </div>
 <button class="winter-button slider-nav" id="nextSlide">▶</button>
</div>

@section Scripts {
<script>
(function(){
 const equipmentSlides = [
 { type: 'blank', img: '/Images/snowboard-113784.jpg' },
 { type: 'Snowboard', img: '/Images/snowboard-113784.jpg' },
 { type: 'Gloves', img: '/Images/ski-glove-6933354.jpg' },
 { type: 'Poles', img: '/Images/ski-poles-252250.jpg' },
 { type: 'Helmet', img: '/Images/helmet-5992804.jpg' },
 { type: 'Skis', img: '/Images/ski-999705.jpg' },
 { type: 'Goggles', img: '/Images/googles-2093046.jpg' },
 { type: 'blank', img: '/Images/googles-2093046.jpg' }
 ];

 let centerIndex =1;
 let equipmentData = [];
 let groupedTypeSize = {};
 const typeNameMap = {0: 'Snowboard',1: 'Gloves',2: 'Poles',3: 'Helmet',4: 'Skis',5: 'Goggles' };
 const sizeNameMap = {0: 'Universal',1: 'Small',2: 'Medium',3: 'Large',4: 'Xl' };

 const apiBase = (window.__rent && window.__rent.apiBase) ? window.__rent.apiBase : '';

 function normalizeType(val) {
 const s = (val === undefined || val === null) ? '' : String(val);
 if (s === '') return '';
 if (typeNameMap[s] === undefined && Object.values(typeNameMap).includes(s)) return s;
 const n = parseInt(s);
 return Number.isFinite(n) && typeNameMap[n] ? typeNameMap[n] : s;
 }
 function normalizeSize(val) {
 const s = (val === undefined || val === null) ? '' : String(val);
 if (s === '') return '';
 if (sizeNameMap[s] === undefined && Object.values(sizeNameMap).includes(s)) return s;
 const n = parseInt(s);
 return Number.isFinite(n) && sizeNameMap[n] ? sizeNameMap[n] : s;
 }

 function buildSlides() {
 const track = document.getElementById('slideTrack');
 track.innerHTML = '';
 equipmentSlides.forEach((s, i) => {
 const slide = document.createElement('div');
 slide.className = 'slide' + (s.type === 'blank' ? ' blank' : '');
 slide.dataset.index = i;
 slide.innerHTML = `<img src='${s.img}' alt='${s.type}'>\n<div class='slide-caption'><span class='cap-type'>${s.type}</span></div>\n<div class='overlay-controls'></div>`;
 track.appendChild(slide);
 });
 }

 function clampCenter(i) { return Math.min(Math.max(i,1), equipmentSlides.length -2); }
 function setCenterToMiddle() { const realCount = equipmentSlides.length -2; const mid = Math.floor((realCount -1) /2); centerIndex = clampCenter(mid +1); }
 function getActiveSlide() { return document.querySelector('.slide.active'); }

 function updateSlider() {
 const track = document.getElementById('slideTrack');
 const offset = -(centerIndex -1) *33.3333;
 track.style.transform = `translateX(${offset}%)`;
 markActive();
 document.getElementById('prevSlide').disabled = (centerIndex ===1);
 document.getElementById('nextSlide').disabled = (centerIndex === equipmentSlides.length -2);
 }

 function markActive() {
 document.querySelectorAll('.slide').forEach(s => s.classList.remove('active', 'neighbor'));
 const slides = document.querySelectorAll('.slide');
 if (!slides.length) return;
 const left = centerIndex -1, right = centerIndex +1;
 slides[centerIndex].classList.add('active');
 if (left >=0) slides[left].classList.add('neighbor');
 if (right < slides.length) slides[right].classList.add('neighbor');
 renderOverlay();
 }

 function renderOverlay() {
 const active = getActiveSlide();
 if (!active) return;
 const currentType = equipmentSlides[centerIndex].type;
 const overlay = active.querySelector('.overlay-controls');
 if (!overlay) return;
 if (currentType === 'blank') { overlay.innerHTML = ''; return; }
 const sizeMap = groupedTypeSize[currentType];
 if (!sizeMap) { overlay.innerHTML = '<div>Brak danych.</div>'; return; }
 const sizeKeys = Object.keys(sizeMap);
 const sizeOptionsHtml = sizeKeys.map((sizeKey, idx) => {
 const arr = sizeMap[sizeKey];
 const available = arr.filter(x => (x.is_In_Werehouse || x.Is_In_Werehouse) && !(x.is_Reserved || x.Is_Reserved)).length;
 // prefer UnitPrice from API (set by EquipmentController), fallback to price/Price
 const price = arr[0].UnitPrice || arr[0].unitPrice || arr[0].price || arr[0].Price ||0;
 return `<option value='${sizeKey}' data-ids='${arr.map(a => a.id || a.Id).join(',')}' data-available='${available}' data-price='${price}' ${idx ===0 ? 'selected' : ''}>${sizeKey} (dostępne: ${available}) — ${(Number(price) ||0).toFixed(2)} zł</option>`;
 }).join('');
 overlay.innerHTML = `\n <div class='overlay-top'>\n <select class='ovSizeSel'>${sizeOptionsHtml}</select>\n <div class='qty-box'>\n <button type='button' class='ovMinus'>-</button>\n <span class='ovQty qty-number'>1</span>\n <button type='button' class='ovPlus'>+</button>\n </div>\n </div>\n <div class='add-row'>\n <div class='price-line'>Cena: <span class='ovUnitPrice'>0,00</span> zł</div>\n <button type='button' class='ovAdd'>➕ Dodaj</button>\n </div>\n <div class='add-info ovInfo'>Dodano do koszyka.</div>`;
 bindOverlayHandlers();
 updateOverlayPrice();
 }

 function updateOverlayPrice() {
 const active = getActiveSlide(); if (!active) return;
 const sel = active.querySelector('.ovSizeSel'); if (!sel) return;
 const opt = sel.selectedOptions[0]; if (!opt) return;
 const unitPriceEl = active.querySelector('.ovUnitPrice');
 const minusBtn = active.querySelector('.ovMinus');
 const plusBtn = active.querySelector('.ovPlus');
 const qtyEl = active.querySelector('.ovQty');
 const price = parseFloat((opt.dataset.price || '').replace(',', '.')) ||0;
 if (unitPriceEl) unitPriceEl.textContent = price.toLocaleString('pl-PL', { minimumFractionDigits:2, maximumFractionDigits:2 });
 let available = parseInt(opt.dataset.available);
 if (!Number.isFinite(available)) {
 const type = equipmentSlides[centerIndex].type;
 const size = opt.value;
 const arr = (groupedTypeSize[type] && groupedTypeSize[type][size]) ? groupedTypeSize[type][size] : [];
 available = arr.filter(x => (x.is_In_Werehouse || x.Is_Werehouse) && !(x.is_Reserved || x.Is_Reserved)).length;
 }
 available = Number.isFinite(available) ? available :0;
 let qty = parseInt(qtyEl?.textContent) ||1;
 if (qty > available) { qty = available >0 ? available :1; if (qtyEl) qtyEl.textContent = qty; }
 if (plusBtn) plusBtn.disabled = qty >= available;
 if (minusBtn) minusBtn.disabled = qty <=1;
 }

 function bindOverlayHandlers() {
 const active = getActiveSlide(); if (!active) return;
 const sel = active.querySelector('.ovSizeSel');
 const minus = active.querySelector('.ovMinus');
 const plus = active.querySelector('.ovPlus');
 const qtyEl = active.querySelector('.ovQty');
 const addBtn = active.querySelector('.ovAdd');
 if (sel) sel.onchange = updateOverlayPrice;
 if (minus) minus.onclick = () => { let v = parseInt(qtyEl.textContent) ||1; if (v >1) { qtyEl.textContent = v -1; updateOverlayPrice(); } };
 if (plus) plus.onclick = () => { let v = parseInt(qtyEl.textContent) ||1; const sel2 = active.querySelector('.ovSizeSel'); const opt = sel2?.selectedOptions[0]; let avail = parseInt(opt?.dataset?.available); if (!Number.isFinite(avail)) { const type = equipmentSlides[centerIndex].type; const size = sel2.value; const arr = (groupedTypeSize[type] && groupedTypeSize[type][size]) ? groupedTypeSize[type][size] : []; avail = arr.filter(x => (x.is_In_Werehouse || x.Is_Werehouse) && !(x.is_Reserved || x.Is_Reserved)).length; } if (v < Math.max(1, avail)) { qtyEl.textContent = v +1; updateOverlayPrice(); } };
 if (addBtn) addBtn.onclick = () => {
 const sel2 = active.querySelector('.ovSizeSel'); const opt = sel2?.selectedOptions[0]; if (!opt) return;
 const qty = parseInt(qtyEl.textContent) ||1;
 let avail = parseInt(opt.dataset.available);
 if (!Number.isFinite(avail)) {
 const type = equipmentSlides[centerIndex].type; const size = sel2.value; const arr = (groupedTypeSize[type] && groupedTypeSize[type][size]) ? groupedTypeSize[type][size] : [];
 avail = arr.filter(x => (x.is_In_Werehouse || x.Is_Werehouse) && !(x.is_Reserved || x.Is_Reserved)).length;
 }
 if (qty > avail) { alert('Brak wystarczającej ilości na stanie.'); return; }
 const ids = (opt.dataset.ids || '').split(',').filter(Boolean).slice(0, qty).map(x => parseInt(x));
 const type = equipmentSlides[centerIndex].type; const size = opt.value;
 const current = getBasket();
 const existingQty = current.filter(i => String(i.Type || i.type) === String(type) && String(i.Size || i.size) === String(size)).reduce((s, i) => s + (parseInt(i.Quantity || i.qty || i.Qty) ||1),0);
 if (existingQty + qty > avail) { alert(`Nie można dodać więcej niż dostępne. ${type} ${size}: dostępne ${avail}, już w koszyku ${existingQty}.`); return; }
 addToBasket({ Type: type, Size: size, Price: parseFloat((opt.dataset.price || '').replace(',', '.')) ||0, Quantity: qty, EquipmentIds: ids });
 const info = active.querySelector('.ovInfo'); if (info) { info.style.display = 'block'; info.classList.add('added-flash'); setTimeout(() => { info.style.display = 'none'; info.classList.remove('added-flash'); },1200); }
 };
 }

 const basketKey = 'basket';
 function getBasket() { try { return JSON.parse(localStorage.getItem(basketKey) || '[]'); } catch { return []; } }
 function saveBasket(b) { localStorage.setItem(basketKey, JSON.stringify(b)); }
 function addToBasket(entry) { const b = getBasket(); b.push(entry); saveBasket(b); }

 function groupEquipment() {
 groupedTypeSize = equipmentData.reduce((acc, e) => {
 const typeRaw = (e.type || e.Type);
 const sizeRaw = (e.size || e.Size);
 const type = normalizeType(typeRaw);
 const size = normalizeSize(sizeRaw);
 if (!type) return acc;
 if (!acc[type]) acc[type] = {}; if (!acc[type][size]) acc[type][size] = [];
 acc[type][size].push(e);
 return acc;
 }, {});
 }

 async function loadEquipment() {
 try { const res = await fetch(`${apiBase}/api/equipment`, { credentials: 'include' }); if (!res.ok) { console.warn('Failed to load equipment, status=', res.status); return; } equipmentData = await res.json(); if (!Array.isArray(equipmentData) || equipmentData.length ===0) { console.info('No equipment data returned'); }
 groupEquipment(); markActive(); }
 catch (err) { console.error('Error loading equipment', err); }
 }

 function initSlider() {
 buildSlides(); setCenterToMiddle(); updateSlider();
 document.getElementById('prevSlide').onclick = () => { centerIndex = clampCenter(centerIndex -1); updateSlider(); };
 document.getElementById('nextSlide').onclick = () => { centerIndex = clampCenter(centerIndex +1); updateSlider(); };
 }

 document.addEventListener('DOMContentLoaded', () => { initSlider(); loadEquipment(); });
})();// IIFE
</script>
}