@page "/WorkerPanel.html"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Worker,Admin")]
@{
 ViewData["Title"] = "Panel pracownika";
}

<style>

 .order-card {
 background: linear-gradient(180deg, rgba(12,39,66,0.75), rgba(12,39,66,0.55));
 border:2px solid #1e4a7a;
 border-radius:14px;
 padding:12px;
 margin:10px0;
 box-shadow:6px18px rgba(0,0,0,0.35);
 }
 .order-items { font-size:.95rem; margin-top:.45rem; color: #eaf6ff }
 .order-actions { display:flex; gap:.6rem; margin-top:.6rem; }
 .ok { background:#27ae60; color:#fff }
 .danger { background:#c0392b; color:#fff }
 .info { background:#2980b9; color:#fff }
 .grid { display:grid; gap:1rem }
 .col { background:transparent; padding:.2rem }
 .section-title { margin:.2rem0 .6rem0; color:#9fc7ff }
 .due { font-size:.75rem; opacity:.85; margin-left:.4rem }
 .report-box {
 background: linear-gradient(180deg, rgba(12,39,66,0.75), rgba(12,39,66,0.55));
 border:2px solid #1e4a7a;
 border-radius:14px;
 padding:12px;
 margin-top: .6rem;
 box-shadow:6px18px rgba(0,0,0,0.35);
 }
 .inline-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:.35rem0; }
 .inline-row label { flex:00160px; width:160px; margin:0; color:#9fc7ff; text-align:left; }
 .inline-row input.form-control { flex:11 auto; min-width:160px; max-width:9999px; margin:0; }
 .inline-row .winter-button { flex:00 auto; margin-left:6px; }
 .msg { font-size:.85rem; margin-top:.25rem; color: #eaf6ff }
 .pdf-export { color:#000 !important; background:#fff !important }
 .pdf-export .order-card { border-color:#000 !important }

 /* small screens: stack label above input */
 @@media (max-width:600px) {
 .inline-row { flex-direction:column; align-items:stretch; }
 .inline-row label { width:auto; flex:00 auto; }
 .inline-row .winter-button { margin-left:0; align-self:flex-start; }
 }
</style>

<h1 class="winter-title">Panel pracownika</h1>
<div class="content-section">
 <div class="frost-effect grid">
 <div class="col">
 <h2 class="section-title">Oczekuj¹ce (do wydania)</h2>
 <div id="ordersPending"></div>
 </div>

 <div class="col">
 <h2 class="section-title">Wydane (czekaj¹ na zwrot)</h2>
 <div id="ordersIssued"></div>
 </div>

 <div class="col report-box">
 <div class="inline-row">
  <button class="winter-button" id="btnReportByEmail">Raport dla email</button>
 <input type="text" id="reportEmail" placeholder="email lub login u¿ytkownika" class="form-control" />
 
 </div>
 <div class="inline-row">
     <button class="winter-button" id="btnReportById">Raport po numerze</button>
     <input type="number" id="reportOrderId" min="1" class="form-control" />
 </div>
 <div class="inline-row" style="justify-content:flex-start">
     <p> </p>
     <p> </p>
     <button class="winter-button" id="btnReportAll">Raport wszystkich zamówieñ</button>
     <button class="winter-button" id="btnDownloadPdf">Pobierz PDF</button>
 </div>
 <div id="reportMsg" class="msg"></div>
 <div id="reportOutput" class="order-items"></div>
 </div>
 </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
(async function(){
 const apiBase = (window.__rent && window.__rent.apiBase) ? window.__rent.apiBase : '';

 async function getMe(){
 if (window.__rent && typeof window.__rent.getMe === 'function') return await window.__rent.getMe();
 try { let r = await fetch(`${apiBase}/api/auth/me`, { credentials: 'include' }); if (!r.ok) r = await fetch(`${apiBase}/api/users/me`, { credentials: 'include' }); if (!r.ok) return null; return await r.json(); } catch { return null; }
 }

 function hasRole(obj, roles){
 if(!obj) return false;
 const userRoles = (obj.Roles || obj.roles) || [];
 return roles.some(r => userRoles.map(x=>String(x).toLowerCase()).includes(r.toLowerCase()));
 }

 async function ensureWorker(){
 const me = await getMe();
 if (hasRole(me, ['Worker','Admin'])) return true;
 
 if (window.auth && typeof window.auth.hasAnyRole === 'function' && window.auth.hasAnyRole('Worker','Admin')) return true;
 return false;
 }

 function formatDateShort(raw){ if(!raw) return ''; const d = new Date(raw); if (isNaN(d.getTime())) return ''; return d.toLocaleDateString('pl-PL'); }

 // normalize and safe helpers
 function safe(v){ if (v === null || v === undefined) return ''; return String(v); }
 function normalizeItemType(i){ if(!i) return ''; if(i.Type) return safe(i.Type); if(i.type) return safe(i.type); if(i.Equipment && (i.Equipment.Type || i.Equipment.type)) return safe(i.Equipment.Type ?? i.Equipment.type); if(i.Equipment && i.Equipment.TypeName) return safe(i.Equipment.TypeName); return ''; }
 function normalizeItemSize(i){ if(!i) return ''; if(i.Size) return safe(i.Size); if(i.size) return safe(i.size); if(i.Equipment && (i.Equipment.Size || i.Equipment.size)) return safe(i.Equipment.Size ?? i.Equipment.size); if(i.Equipment && i.Equipment.SizeName) return safe(i.Equipment.SizeName); return ''; }

 function render(list, type){
 if(!Array.isArray(list) || !list.length) return '<div class="contact-item">Brak zamówieñ.</div>';
 return list.map(o=>{
 // user name: support different API shapes
 let user = '';
 if (o.User) {
 user = [o.User.FirstName, o.User.First_name, o.User.first_name, o.User.firstName, o.User.LastName, o.User.Last_name, o.User.last_name]
 .filter(Boolean).slice(0,2).join(' ');
 if (!user) {
 // try explicit properties returned by OrdersController (FirstName/LastName)
 user = ((o.User.FirstName || '') + ' ' + (o.User.LastName || '')).trim();
 }
 }
 if (!user) user = (o.UserFirstName || o.UserFirst_Name || '') + ' ' + (o.UserLastName || o.UserLast_Name || '');
 user = user.trim() || '—';

 const total = Number(o.Price ||0).toFixed(2);

 let itemsHtml = '';
 if (Array.isArray(o.ItemsGrouped) && o.ItemsGrouped.length){
 itemsHtml = o.ItemsGrouped.map(g => {
 const t = safe(g.Type || g.type || g.TypeName);
 const s = safe(g.Size || g.size || g.SizeName);
 const c = g.Count ?? g.count ?? '';
 return `${t} ${s}`.trim() + (c ? ` × ${c}` : '');
 }).join('<br>');
 } else if (Array.isArray(o.Items) && o.Items.length) {
 itemsHtml = o.Items.map(i => {
 const t = normalizeItemType(i) || 'brak';
 const s = normalizeItemSize(i) || '';
 const q = i.Quantity ?? i.quantity ?? i.Qty ?? i.qty ??1;
 const p = Number(i.PriceWhenOrdered ?? i.Price ?? i.price ??0).toFixed(2);
 return `${t}${s ? ' ' + s : ''} × ${q} — ${p} z³`;
 }).join('<br>');
 } else {

 const rentedTxt = o.Rented_Items || o.rented_Items || o.rented_items || '';
 itemsHtml = safe(rentedTxt);
 }

 let actions = '';
 if(type === 'pending'){
 actions = `<button class='winter-button ok' data-accept='${o.Id}'>Akceptuj (wydaj)</button> <button class='winter-button danger' data-delete='${o.Id}'>Usuñ</button>`;
 } else {
 actions = `<button class='winter-button info' data-return='${o.Id}'>Zwrot</button>`;
 }
 const due = type === 'issued' ? (formatDateShort(o.DueDate) || '') : '';
 return `<div class='order-card'>
 <div><strong>Zamówienie #${safe(o.Id)}</strong> — ${user} — Suma: ${total} z³ ${due ? `<span class='due'>Termin zwrotu: ${due}</span>` : ''}</div>
 <div class='order-items'>${itemsHtml}</div>
 <div class='order-actions'>${actions}</div>
 </div>`;
 }).join('');
 }

 async function load(){
 try{
 const [pRes, iRes] = await Promise.all([
 fetch(`${apiBase}/api/orders/pending`, { credentials: 'include' }),
 fetch(`${apiBase}/api/orders/issued`, { credentials: 'include' })
 ]);
 const reportMsg = document.getElementById('reportMsg'); reportMsg.textContent = '';
 if (!pRes.ok) {
 const txt = await pRes.text(); reportMsg.textContent = `B³¹d ³adowania zamówieñ oczekuj¹cych: ${pRes.status} ${txt || pRes.statusText}`; console.error('pending error', pRes.status, txt);
 } else {
 const pending = await pRes.json(); document.getElementById('ordersPending').innerHTML = render(pending,'pending');
 }
 if (!iRes.ok) {
 const txt = await iRes.text(); reportMsg.textContent += `\nB³¹d ³adowania zamówieñ wydanych: ${iRes.status} ${txt || iRes.statusText}`; console.error('issued error', iRes.status, txt);
 } else {
 const issued = await iRes.json(); document.getElementById('ordersIssued').innerHTML = render(issued,'issued');
 }
 bind();
 }catch(err){ console.error(err); document.getElementById('reportMsg').textContent = 'B³¹d ³adowania zamówieñ: ' + (err.message || err); }
 }

 async function call(url, method){ const res = await fetch(url, { method, credentials: 'include' }); const txt = await res.text(); if(!res.ok) throw new Error(txt || ('HTTP '+res.status)); return txt; }

 function renderReport(list, title){ if(!Array.isArray(list)) list = list ? [list] : []; if(!list.length) return `<div class='contact-item'>Brak danych dla raportu: ${title}</div>`; return `<div class='order-items'><strong>${title}</strong></div>` + list.map(o=>{ const due = formatDateShort(o.DueDate)||''; // user name - support shapes
 let user = '';
 if (o.User) user = ((o.User.FirstName || o.User.First_name || o.User.first_name || '') + ' ' + (o.User.LastName || o.User.Last_name || '')).trim();
 if(!user) user = (o.UserFirstName || o.UserFirst_Name || '') + ' ' + (o.UserLastName || o.UserLast_Name || '');
 user = user.trim();
 const items = (o.ItemsGrouped || []).map(g=>`${g.Type} ${g.Size} × ${g.Count}`).join(', ');
 return `<div class='order-card'>Zamówienie #${safe(o.Id)} — ${new Date(o.OrderDate).toLocaleString('pl-PL')} — ${user} — Suma: ${Number(o.Price||0).toFixed(2)} z³ ${due?` — Termin: ${due}`:''}<br><span class='order-items'>${items||''}</span></div>`; }).join(''); }

 function bind(){
 const P = document.getElementById('ordersPending'); const I = document.getElementById('ordersIssued'); const Out = document.getElementById('reportOutput'); const Msg = document.getElementById('reportMsg');
 if(P) P.querySelectorAll('[data-accept]').forEach(b=>{ b.onclick = async ()=>{ b.disabled = true; const id = b.getAttribute('data-accept'); try{ await call(`${apiBase}/api/orders/${id}/accept`, 'POST'); } catch(e){ Msg.textContent = 'Akceptacja nie powiod³a siê: ' + (e.message || e); console.error(e); } finally{ b.disabled = false; load(); } } });
 if(P) P.querySelectorAll('[data-delete]').forEach(b=>{ b.onclick = async ()=>{ b.disabled = true; const id = b.getAttribute('data-delete'); try{ await call(`${apiBase}/api/orders/${id}`, 'DELETE'); } catch(e){ Msg.textContent = 'Usuwanie nie powiod³o siê: ' + (e.message || e); console.error(e); } finally{ b.disabled = false; load(); } } });
 if(I) I.querySelectorAll('[data-return]').forEach(b=>{ b.onclick = async ()=>{ b.disabled = true; const id = b.getAttribute('data-return'); try{ await call(`${apiBase}/api/orders/${id}/returned`, 'POST'); } catch(e){ Msg.textContent = 'Zwrot nie powiód³ siê: ' + (e.message || e); console.error(e); } finally{ b.disabled = false; load(); } } });

 document.getElementById('btnReportByEmail').onclick = async ()=>{
 Msg.textContent = ''; Out.innerHTML = '';
 const email = document.getElementById('reportEmail').value.trim(); if(!email){ Msg.textContent = 'Podaj email lub login u¿ytkownika.'; return; }
 try{
 const res = await fetch(`${apiBase}/api/orders/by-email?email=${encodeURIComponent(email)}`, { credentials: 'include' });
 if(!res.ok){ const txt = await res.text(); Msg.textContent = txt || ('B³¹d HTTP ' + res.status); return; }
 const data = await res.json(); Out.innerHTML = renderReport(data, 'Raport dla: ' + email);
 } catch(err){ Msg.textContent = 'B³¹d: ' + (err.message || err); console.error(err); }
 };

 document.getElementById('btnReportById').onclick = async ()=>{
 Msg.textContent = ''; Out.innerHTML = '';
 const id = parseInt(document.getElementById('reportOrderId').value,10); if(!id){ Msg.textContent = 'Podaj poprawny numer zamówienia.'; return; }
 try{
 const url = `${apiBase}/api/orders/report?id=${encodeURIComponent(id)}`;
 const res = await fetch(url, { credentials: 'include' });
 const txt = await res.text(); if(!res.ok){ Msg.textContent = txt || ('B³¹d HTTP ' + res.status); return; }
 let data = null; try{ data = JSON.parse(txt);}catch{}
 Out.innerHTML = renderReport(data, 'Raport zamówienie #' + id);
 } catch(err){ Msg.textContent = 'B³¹d: ' + (err.message || err); console.error(err); }
 };

 document.getElementById('btnReportAll').onclick = async ()=>{ Msg.textContent = ''; Out.innerHTML = ''; try{
 const res = await fetch(`${apiBase}/api/orders/all`, { credentials: 'include' }); if(!res.ok){ const txt = await res.text(); document.getElementById('reportMsg').textContent = txt || ('B³¹d HTTP ' + res.status); return; } const data = await res.json(); Out.innerHTML = renderReport(data, 'Raport wszystkich zamówieñ'); } catch(err){ document.getElementById('reportMsg').textContent = 'B³¹d: ' + (err.message || err); console.error(err); } };

 document.getElementById('btnDownloadPdf').onclick = async ()=>{
 if(!document.getElementById('reportOutput').innerHTML.trim()){ document.getElementById('reportMsg').textContent = 'Najpierw wygeneruj raport.'; return; }
 try{ document.getElementById('reportOutput').classList.add('pdf-export'); const canvas = await html2canvas(document.getElementById('reportOutput'), { scale:2, backgroundColor:'#ffffff' }); document.getElementById('reportOutput').classList.remove('pdf-export'); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF({ unit:'pt', format:'a4' }); const pageWidth = pdf.internal.pageSize.getWidth(); const pageHeight = pdf.internal.pageSize.getHeight(); const imgWidth = pageWidth -40; const imgHeight = canvas.height * imgWidth / canvas.width; if (imgHeight <= pageHeight -40) { pdf.addImage(imgData, 'PNG',20,20, imgWidth, imgHeight); } else { let remaining = imgHeight; let yCanvas =0; const ratio = imgWidth / canvas.width; const slicePx = (pageHeight -40) / ratio; while(remaining >0){ const pageCanvas = document.createElement('canvas'); pageCanvas.width = canvas.width; pageCanvas.height = Math.min(slicePx, canvas.height - yCanvas); const ctx = pageCanvas.getContext('2d'); ctx.drawImage(canvas,0, yCanvas, pageCanvas.width, pageCanvas.height,0,0, pageCanvas.width, pageCanvas.height); const pageImg = pageCanvas.toDataURL('image/png'); pdf.addImage(pageImg, 'PNG',20,20, imgWidth, pageCanvas.height * ratio); remaining -= pageCanvas.height * ratio; yCanvas += pageCanvas.height; if(remaining >0) pdf.addPage(); } } pdf.save('raport.pdf'); } catch(err){ document.getElementById('reportMsg').textContent = 'Nie uda³o siê wygenerowaæ PDF: ' + (err.message || err); } }
 }

 // initial
 const ok = await ensureWorker(); if(!ok){ window.location.href = '/Login.html'; return; }
 load();

})();
</script>
}