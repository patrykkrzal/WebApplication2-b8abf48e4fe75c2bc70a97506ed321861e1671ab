@page "/WorkerPanel.html"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Worker,Admin")]
@{
 ViewData["Title"] = "Panel pracownika";
}

<style>
 .order-card { background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:.8rem; margin:.6rem0; }
 .order-items { font-size:.9rem; margin-top:.4rem; }
 .order-actions { display:flex; gap:.5rem; margin-top:.6rem; }
 .ok { background:#27ae60; color:#fff }
 .danger { background:#c0392b; color:#fff }
 .info { background:#2980b9; color:#fff }
 .grid { display:grid; gap:1rem }
 .col { background:transparent; padding:.2rem }
 .section-title { margin:.2rem0 .6rem0 }
 .due { font-size:.75rem; opacity:.85; margin-left:.4rem }
 .report-box { background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:.8rem; margin-top:.8rem }
 .inline-row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin:.35rem0 }
 .inline-row input { flex:1; min-width:220px }
 .msg { font-size:.85rem; margin-top:.25rem }
 .pdf-export { color:#000 !important; background:#fff !important }
 .pdf-export .order-card { border-color:#000 !important }
</style>

<h1 class="winter-title">Panel pracownika</h1>
<div class="content-section">
 <div class="frost-effect grid">
 <div class="col">
 <h2 class="section-title">Oczekuj¹ce (do wydania)</h2>
 <div id="ordersPending"></div>
 </div>

 <div class="col">
 <h2 class="section-title">Wydane (czekaj¹ na zwrot)</h2>
 <div id="ordersIssued"></div>
 </div>

 <div class="col report-box">
 <h2 class="section-title">?? Raporty</h2>
 <div class="inline-row">
 <label for="reportEmail" style="margin:0">Email u¿ytkownika:</label>
 <input type="text" id="reportEmail" placeholder="email lub login u¿ytkownika" class="form-control" />
 <button class="winter-button" id="btnReportByEmail">Raport dla email</button>
 </div>
 <div class="inline-row">
 <label for="reportOrderId" style="margin:0">Numer zamówienia:</label>
 <input type="number" id="reportOrderId" min="1" class="form-control" />
 <button class="winter-button" id="btnReportById">Raport po numerze</button>
 </div>
 <div class="inline-row" style="justify-content:flex-start">
 <button class="winter-button" id="btnReportAll">Raport wszystkich zamówieñ</button>
 <button class="winter-button" id="btnDownloadPdf">Pobierz PDF</button>
 </div>
 <div id="reportMsg" class="msg"></div>
 <div id="reportOutput" class="order-items"></div>
 </div>
 </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
(async function(){
 const apiBase = (window.__rent && window.__rent.apiBase) ? window.__rent.apiBase : '';

 async function getMe(){
 if (window.__rent && typeof window.__rent.getMe === 'function') return await window.__rent.getMe();
 try { let r = await fetch(`${apiBase}/api/auth/me`, { credentials: 'include' }); if (!r.ok) r = await fetch(`${apiBase}/api/users/me`, { credentials: 'include' }); if (!r.ok) return null; return await r.json(); } catch { return null; }
 }

 function hasRole(obj, roles){
 if(!obj) return false;
 const userRoles = (obj.Roles || obj.roles) || [];
 return roles.some(r => userRoles.map(x=>String(x).toLowerCase()).includes(r.toLowerCase()));
 }

 async function ensureWorker(){
 const me = await getMe();
 if (hasRole(me, ['Worker','Admin'])) return true;
 // fallback to window.auth if present
 if (window.auth && typeof window.auth.hasAnyRole === 'function' && window.auth.hasAnyRole('Worker','Admin')) return true;
 return false;
 }

 function formatDateShort(raw){ if(!raw) return ''; const d = new Date(raw); if (isNaN(d.getTime())) return ''; return d.toLocaleDateString('pl-PL'); }

 function render(list, type){
 if(!Array.isArray(list) || !list.length) return '<div class="contact-item">Brak zamówieñ.</div>';
 return list.map(o=>{
 const user = o.User ? `${o.User.First_name || o.User.first_name || ''} ${o.User.Last_name || o.User.last_name || ''}`.trim() : '—';
 const total = Number(o.Price ||0).toFixed(2);
 const items = (o.Items || []).map(i=>`${i.Type} ${i.Size} × ${i.Quantity} — ${Number(i.PriceWhenOrdered ||0).toFixed(2)} z³`).join('<br>');
 let actions = '';
 if(type === 'pending'){
 actions = `<button class='winter-button ok' data-accept='${o.Id}'>Akceptuj (wydaj)</button> <button class='winter-button danger' data-delete='${o.Id}'>Usuñ</button>`;
 } else {
 actions = `<button class='winter-button info' data-return='${o.Id}'>Zwrot</button>`;
 }
 const due = type === 'issued' ? (formatDateShort(o.DueDate) || '') : '';
 return `<div class='order-card'>
 <div><strong>Zamówienie #${o.Id}</strong> — ${user} — Suma: ${total} z³ ${due ? `<span class='due'>Termin zwrotu: ${due}</span>` : ''}</div>
 <div class='order-items'>${items}</div>
 <div class='order-actions'>${actions}</div>
 </div>`;
 }).join('');
 }

 async function load(){
 try{
 const [pRes, iRes] = await Promise.all([
 fetch(`${apiBase}/api/orders/pending`, { credentials: 'include' }),
 fetch(`${apiBase}/api/orders/issued`, { credentials: 'include' })
 ]);
 const pending = pRes.ok ? await pRes.json() : [];
 const issued = iRes.ok ? await iRes.json() : [];
 document.getElementById('ordersPending').innerHTML = render(pending,'pending');
 document.getElementById('ordersIssued').innerHTML = render(issued,'issued');
 bind();
 }catch(err){ console.error(err); }
 }

 async function call(url, method){ const res = await fetch(url, { method, credentials: 'include' }); const txt = await res.text(); if(!res.ok) throw new Error(txt || ('HTTP '+res.status)); return txt; }

 function renderReport(list, title){ if(!Array.isArray(list)) list = list ? [list] : []; if(!list.length) return `<div class='contact-item'>Brak danych dla raportu: ${title}</div>`; return `<div class='order-items'><strong>${title}</strong></div>` + list.map(o=>{ const due = formatDateShort(o.DueDate)||''; const user = o.User ? `${o.User.First_name || ''} ${o.User.Last_Name || ''}`.trim() : ''; const items = (o.ItemsGrouped || []).map(g=>`${g.Type} ${g.Size} × ${g.Count}`).join(', '); return `<div class='order-card'>Zamówienie #${o.Id} — ${new Date(o.OrderDate).toLocaleString('pl-PL')} — ${user} — Suma: ${Number(o.Price||0).toFixed(2)} z³ ${due?`— Termin: ${due}`:''}<br><span class='order-items'>${items||''}</span></div>`; }).join(''); }

 function bind(){
 const P = document.getElementById('ordersPending'); const I = document.getElementById('ordersIssued'); const Out = document.getElementById('reportOutput'); const Msg = document.getElementById('reportMsg');
 P.querySelectorAll('[data-accept]').forEach(b=>{ b.onclick = async ()=>{ b.disabled = true; const id = b.getAttribute('data-accept'); try{ await call(`${apiBase}/api/orders/${id}/accept`, 'POST'); } finally{ b.disabled = false; load(); } } });
 P.querySelectorAll('[data-delete]').forEach(b=>{ b.onclick = async ()=>{ b.disabled = true; const id = b.getAttribute('data-delete'); try{ await call(`${apiBase}/api/orders/${id}`, 'DELETE'); } finally{ b.disabled = false; load(); } } });
 I.querySelectorAll('[data-return]').forEach(b=>{ b.onclick = async ()=>{ b.disabled = true; const id = b.getAttribute('data-return'); try{ await call(`${apiBase}/api/orders/${id}/returned`, 'POST'); } finally{ b.disabled = false; load(); } } });

 document.getElementById('btnReportByEmail').onclick = async ()=>{
 Msg.textContent = ''; Out.innerHTML = '';
 const email = document.getElementById('reportEmail').value.trim(); if(!email){ Msg.textContent = 'Podaj email lub login u¿ytkownika.'; return; }
 const res = await fetch(`${apiBase}/api/orders/by-email?email=${encodeURIComponent(email)}`, { credentials: 'include' }); const data = res.ok ? await res.json() : []; Out.innerHTML = renderReport(data, 'Raport dla: ' + email);
 };

 document.getElementById('btnReportById').onclick = async ()=>{
 Msg.textContent = ''; Out.innerHTML = '';
 const id = parseInt(document.getElementById('reportOrderId').value,10); if(!id){ Msg.textContent = 'Podaj poprawny numer zamówienia.'; return; }
 const url = `${apiBase}/api/orders/report?id=${encodeURIComponent(id)}`;
 const res = await fetch(url, { credentials: 'include' }); const txt = await res.text(); let data = null; try{ data = JSON.parse(txt);}catch{}
 if(!res.ok){ Msg.textContent = (data && data.Message) ? data.Message : (txt || ('B³¹d HTTP ' + res.status)); return; }
 Out.innerHTML = renderReport(data, 'Raport zamówienie #' + id);
 };

 document.getElementById('btnReportAll').onclick = async ()=>{ Msg.textContent = ''; Out.innerHTML = ''; const res = await fetch(`${apiBase}/api/orders/all`, { credentials: 'include' }); const data = res.ok ? await res.json() : []; Out.innerHTML = renderReport(data, 'Raport wszystkich zamówieñ'); };

 document.getElementById('btnDownloadPdf').onclick = async ()=>{
 if(!document.getElementById('reportOutput').innerHTML.trim()){ document.getElementById('reportMsg').textContent = 'Najpierw wygeneruj raport.'; return; }
 try{ document.getElementById('reportOutput').classList.add('pdf-export'); const canvas = await html2canvas(document.getElementById('reportOutput'), { scale:2, backgroundColor:'#ffffff' }); document.getElementById('reportOutput').classList.remove('pdf-export'); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF({ unit:'pt', format:'a4' }); const pageWidth = pdf.internal.pageSize.getWidth(); const pageHeight = pdf.internal.pageSize.getHeight(); const imgWidth = pageWidth -40; const imgHeight = canvas.height * imgWidth / canvas.width; if (imgHeight <= pageHeight -40) { pdf.addImage(imgData, 'PNG',20,20, imgWidth, imgHeight); } else { let remaining = imgHeight; let yCanvas =0; const ratio = imgWidth / canvas.width; const slicePx = (pageHeight -40) / ratio; while(remaining >0){ const pageCanvas = document.createElement('canvas'); pageCanvas.width = canvas.width; pageCanvas.height = Math.min(slicePx, canvas.height - yCanvas); const ctx = pageCanvas.getContext('2d'); ctx.drawImage(canvas,0, yCanvas, pageCanvas.width, pageCanvas.height,0,0, pageCanvas.width, pageCanvas.height); const pageImg = pageCanvas.toDataURL('image/png'); pdf.addImage(pageImg, 'PNG',20,20, imgWidth, pageCanvas.height * ratio); remaining -= pageCanvas.height * ratio; yCanvas += pageCanvas.height; if(remaining >0) pdf.addPage(); } } pdf.save('raport.pdf'); } catch(err){ document.getElementById('reportMsg').textContent = 'Nie uda³o siê wygenerowaæ PDF: ' + (err.message || err); } };
 }

 // initial
 const ok = await ensureWorker(); if(!ok){ window.location.href = '/Login.html'; return; }
 load();

})();
</script>
}