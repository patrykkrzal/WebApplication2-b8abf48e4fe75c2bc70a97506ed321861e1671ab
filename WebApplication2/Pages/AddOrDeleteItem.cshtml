@page "/AddOrDeleteItem.html"
@{
 ViewData["Title"] = "Dodaj / Usuñ sprzêt";
}

<h1 class="winter-title">Zarz¹dzanie sprzêtem</h1>
<p class="mb-3">Dodaj lub usuñ pojedyncz¹ pozycjê. Dostêp tylko dla ról Admin lub Pracownik.</p>

<div id="roleGuard" class="alert alert-warning" style="display:none">
 Brak uprawnieñ. Ta strona jest dostêpna tylko dla u¿ytkowników z rol¹ Admin lub Worker.
</div>

<details class="user-panel" id="addPanel" open>
 <summary class="winter-button" aria-label="Dodaj sprzêt">? / ? Sprzêt</summary>

 <form id="addItemForm" class="form-box" novalidate style="display:none">
 <div class="mb-3">
 <label for="type">Rodzaj sprzêtu</label>
 <select id="type" name="Type" class="form-select" required>
 <option value="">-- wybierz --</option>
 <option value="Skis">Narty</option>
 <option value="Helmet">Kask</option>
 <option value="Gloves">Rêkawice</option>
 <option value="Poles">Kijki</option>
 <option value="Snowboard">Snowboard</option>
 <option value="Goggles">Gogle</option>
 </select>
 </div>

 <div class="mb-3">
 <label for="size">Rozmiar</label>
 <select id="size" name="Size" class="form-select" required disabled>
 <option value="">Najpierw wybierz typ</option>
 </select>
 <div id="sizeHint" class="form-text">
 Dostêpne rozmiary zale¿¹ od wybranego typu i stanu magazynowego.
 </div>
 </div>

 <div class="dual-actions">
 <button type="submit" class="submit-btn" id="btnAdd">Dodaj</button>
 <button type="button" class="submit-btn" id="btnDelete" style="background:#aa3333">Usuñ</button>
 </div>

 <div id="msg" class="msg"></div>
 </form>
</details>

@section Scripts {
 <script>
    (function(){
     const apiBase = (window.__rent && window.__rent.apiBase) ? window.__rent.apiBase : '';

     function toDto() {
     const type = document.getElementById('type').value;
     const size = document.getElementById('size').value;
     return { Type: type, Size: size };
     }

     async function postJson(url, body) {
     const res = await fetch(url, {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify(body),
     credentials: 'include'
     });

     let text = await res.text();
     try { text = JSON.parse(text); } catch { }

     if (!res.ok)
     throw (typeof text === 'string' ? new Error(text) : new Error(JSON.stringify(text)));

     return text;
     }

     async function deleteJson(url, body) {
     const res = await fetch(url, {
     method: 'DELETE',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify(body),
     credentials: 'include'
     });

     let text = await res.text();
     try { text = JSON.parse(text); } catch { }

     if (!res.ok)
     throw (typeof text === 'string' ? new Error(text) : new Error(JSON.stringify(text)));

     return text;
     }

     async function getMe() {
     if (window.__rent && typeof window.__rent.getMe === 'function') {
     try { return await window.__rent.getMe(); } catch { /* fallback */ }
     }
     try {
     let res = await fetch(`${apiBase}/api/Auth/me`, { credentials: 'include' });
     if (!res.ok) res = await fetch('/api/users/me', { credentials: 'include' });
     if (!res.ok) return null;

     try { return await res.json(); }
     catch { return null; }
     } catch { return null; }
     }

     async function getAvailability() {
     try {
     const res = await fetch(`${apiBase}/api/equipment/availability`, { credentials: 'include' });
     if (!res.ok) return [];
     return await res.json();
     } catch { return []; }
     }

     let availabilityByType = {};
     function buildAvailabilityMap(items) {
     availabilityByType = {};
     items.forEach(x => {
     const t = String(x.Type || '').trim();
     const s = String(x.Size || '').trim();
     if (!t || !s) return;
     (availabilityByType[t] ||= new Set()).add(s);
     });
     }

     const sizeMap = {
     Skis: ['Small', 'Medium', 'Large'],
     Snowboard: ['Small', 'Medium', 'Large'],
     Poles: ['Small', 'Medium', 'Large'],
     Helmet: ['Small', 'Medium', 'Large'],
     Gloves: ['Small', 'Medium', 'Large'],
     Goggles: ['Universal']
     };

     function tSize(sz) {
     const m = { Small: 'Ma³y', Medium: 'Œredni', Large: 'Du¿y', Universal: 'Uniwersalny' };
     return m[sz] || sz;
     }

     function makeOption(value) {
     const opt = document.createElement('option');
     opt.value = value;
     opt.textContent = tSize(value);
     return opt;
     }

     function populateSizesForType(type) {
     const sizeSelect = document.getElementById('size');
     sizeSelect.innerHTML = '';

     const sizes = availabilityByType[type] ? Array.from(availabilityByType[type]) : (sizeMap[type] || ['Small', 'Medium', 'Large']);
     sizes.forEach(sz => sizeSelect.appendChild(makeOption(sz)));
     sizeSelect.disabled = false;
     }

     async function ensureRoles() {
     const me = await getMe();
     const guard = document.getElementById('roleGuard');
     const form = document.getElementById('addItemForm');

     const hasAccess = me && (Array.isArray(me.Roles) || Array.isArray(me.roles)) && (me.Roles || me.roles).some(r => ['Admin', 'Worker'].includes(r));

     if (!hasAccess) {
     guard.style.display = 'block';
     form.style.display = 'none';
     document.getElementById('addPanel').classList.add('disabled');
     } else {
     guard.style.display = 'none';
     form.style.display = 'block';
     document.getElementById('addPanel').classList.remove('disabled');
     }
     }

     document.getElementById('type').addEventListener('change', e => {
     const type = e.target.value;
     const sizeSelect = document.getElementById('size');

     if (!type) {
     sizeSelect.innerHTML = '<option value="">Najpierw wybierz typ</option>';
     sizeSelect.disabled = true;
     return;
     }

     populateSizesForType(type);
     });

     document.getElementById('addItemForm').addEventListener('submit', async e => {
     e.preventDefault();
     const msg = document.getElementById('msg');
     msg.className = 'msg';
     msg.textContent = 'Dodawanie...';
     try {
     const dto = toDto();
     const result = await postJson(`${apiBase}/api/equipment/add`, dto);
     msg.className = 'msg success';
     msg.textContent = `Dodano: ${result.Type ?? dto.Type} ${result.Size ?? dto.Size}. Cena: ${result.Price}`;
     e.target.reset();
     document.getElementById('size').disabled = true;
     document.getElementById('size').innerHTML = '<option value="">Najpierw wybierz typ</option>';
     } catch (err) {
     msg.className = 'msg error';
     msg.textContent = 'B³¹d: ' + (err.message || err);
     }
     });

     document.getElementById('btnDelete').addEventListener('click', async () => {
     const msg = document.getElementById('msg');
     msg.className = 'msg';
     msg.textContent = 'Usuwanie...';
     try {
     const dto = toDto();
     if (!dto.Type || !dto.Size) throw new Error('Wybierz typ i rozmiar');
     const result = await deleteJson(`${apiBase}/api/equipment/delete`, dto);
     msg.className = 'msg success';
     msg.textContent = `Usuniêto: ${dto.Type} ${dto.Size}. Pozosta³o: ${result.Remaining}`;
     } catch (err) {
     msg.className = 'msg error';
     msg.textContent = 'B³¹d usuwania: ' + (err.message || err);
     }
     });

     (async function init(){
     await ensureRoles();
     const items = await getAvailability();
     buildAvailabilityMap(items);
     })();
    })();
    </script>
}