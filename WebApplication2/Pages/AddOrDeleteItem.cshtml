@page "/AddOrDeleteItem.html"
@{
 ViewData["Title"] = "Dodaj / Usuń sprzęt";
}

<style>
/* Keep outer content-section background intact; only remove inner form "card" for add/delete page */
.form-box { background: transparent !important; box-shadow: none !important; padding:0 !important; margin-top:12px !important; }
</style>

<h1 class="winter-title">Zarządzanie sprzętem</h1>

<!-- Add/Delete form below, centered using dedicated CSS -->
<div class="add-item-wrapper">
 <details class="user-panel" id="addPanel" open>
 <summary class="winter-button" aria-label="Dodaj sprzęt">➕ / ➖ Sprzęt</summary>

 <form id="addItemForm" class="form-box" novalidate>
 <div class="mb-3">
 <label for="type">Rodzaj sprzętu</label>
 <select id="type" name="Type" class="form-select" required>
 <option value="">-- wybierz --</option>
 <option value="Skis">Narty</option>
 <option value="Helmet">Kask</option>
 <option value="Gloves">Rękawice</option>
 <option value="Poles">Kijki</option>
 <option value="Snowboard">Snowboard</option>
 <option value="Goggles">Gogle</option>
 </select>
 </div>

 <div class="mb-3">
 <label for="size">Rozmiar <span id="sizeAvailable" style="font-weight:600; margin-left:8px; color:var(--btn-text);"></span></label>
 <select id="size" name="Size" class="form-select" required disabled>
 <option value="">Najpierw wybierz typ</option>
 </select>
 <div id="sizeHint" class="form-text">
 Dostępne rozmiary zależą od wybranego typu i stanie magazynowym.
 </div>
 </div>

 <div class="mb-3">
 <label for="quantity">Ilość</label>
 <input id="quantity" name="Quantity" type="number" min="1" value="1" class="form-control" />
 </div>

 <div class="dual-actions">
 <button type="submit" class="submit-btn" id="btnAdd">➕ Dodaj</button>
 <button type="button" class="submit-btn delete-btn" id="btnDelete">➖ Usuń</button>
 </div>

 <div id="msg" class="msg"></div>
 </form>
 </details>
</div>

@section Scripts {
 <script>
 (function(){
 const apiBase = (window.__rent && window.__rent.apiBase) ? window.__rent.apiBase : '';

 function toDto() {
 const type = document.getElementById('type').value;
 const size = document.getElementById('size').value;
 const qtyRaw = document.getElementById('quantity').value;
 return { Type: type, Size: size, Quantity: qtyRaw ? parseInt(qtyRaw) :1 };
 }

 async function postJson(url, body) {
 const res = await fetch(url, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify(body),
 credentials: 'include'
 });

 let text = await res.text();
 try { text = JSON.parse(text); } catch { }

 if (!res.ok)
 throw (typeof text === 'string' ? new Error(text) : new Error(JSON.stringify(text)));

 return text;
 }

 async function deleteJson(url, body) {
 const res = await fetch(url, {
 method: 'DELETE',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify(body),
 credentials: 'include'
 });

 let text = await res.text();
 try { text = JSON.parse(text); } catch { }

 if (!res.ok)
 throw (typeof text === 'string' ? new Error(text) : new Error(JSON.stringify(text)));

 return text;
 }

 async function getMe() {
 if (window.__rent && typeof window.__rent.getMe === 'function') {
 try { return await window.__rent.getMe(); } catch { /* fallback */ }
 }
 try {
 let res = await fetch(`${apiBase}/api/Auth/me`, { credentials: 'include' });
 if (!res.ok) res = await fetch('/api/users/me', { credentials: 'include' });
 if (!res.ok) return null;

 try { return await res.json(); }
 catch { return null; }
 } catch { return null; }
 }

 async function getAvailability() {
 try {
 const res = await fetch(`${apiBase}/api/equipment/availability`, { credentials: 'include' });
 if (!res.ok) return [];
 return await res.json();
 } catch { return []; }
 }

 let availabilityByType = {}; // { type: { size: count } }
 function buildAvailabilityMap(items) {
 availabilityByType = {};
 items.forEach(x => {
 const t = String(x.Type || '').trim();
 const s = String(x.Size || '').trim();
 const c = parseInt(x.Count ||0) ||0;
 if (!t || !s) return;
 if (!availabilityByType[t]) availabilityByType[t] = {};
 availabilityByType[t][s] = c;
 });
 }

 const sizeMap = {
 Skis: ['Small', 'Medium', 'Large'],
 Snowboard: ['Small', 'Medium', 'Large'],
 Poles: ['Small', 'Medium', 'Large'],
 Helmet: ['Small', 'Medium', 'Large'],
 Gloves: ['Small', 'Medium', 'Large'],
 Goggles: ['Universal']
 };

 function tSize(sz) {
 const m = { Small: 'Mały', Medium: 'Średni', Large: 'Duży', Universal: 'Uniwersalny' };
 return m[sz] || sz;
 }

 function makeOption(value, available) {
 const opt = document.createElement('option');
 opt.value = value;
 opt.textContent = `${tSize(value)}${(typeof available === 'number') ? ` (dostępne: ${available})` : ''}`;
 if (typeof available === 'number') opt.dataset.available = available;
 return opt;
 }

 function populateSizesForType(type) {
 const sizeSelect = document.getElementById('size');
 sizeSelect.innerHTML = '';

 const sizes = availabilityByType[type] ? Object.keys(availabilityByType[type]) : (sizeMap[type] || ['Small', 'Medium', 'Large']);
 if (!sizes || sizes.length ===0) {
 sizeSelect.appendChild(new Option('Brak dostępnych rozmiarów', ''));
 sizeSelect.disabled = true;
 document.getElementById('sizeAvailable').textContent = '';
 return;
 }
 sizes.forEach(sz => {
 const avail = (availabilityByType[type] && availabilityByType[type][sz] != null) ? availabilityByType[type][sz] : undefined;
 sizeSelect.appendChild(makeOption(sz, avail));
 });
 sizeSelect.disabled = false;
 sizeSelect.classList.remove('selected');
 // select first and trigger change to update availability display
 sizeSelect.selectedIndex =0;
 onSizeChanged();
 }

 function onSizeChanged() {
 const sizeSelect = document.getElementById('size');
 const opt = sizeSelect.selectedOptions[0];
 const availSpan = document.getElementById('sizeAvailable');
 const qtyEl = document.getElementById('quantity');
 if (!opt) { availSpan.textContent = ''; qtyEl.min =1; return; }
 const available = parseInt(opt.dataset.available);
 if (Number.isFinite(available)) {
 availSpan.textContent = `Dostępne: ${available}`;
 qtyEl.max = Math.max(1, available);
 if (parseInt(qtyEl.value) > available) qtyEl.value = available >0 ? available :1;
 } else {
 availSpan.textContent = '';
 qtyEl.removeAttribute('max');
 }
 }

 async function ensureRoles() {
 const me = await getMe();
 const guard = document.getElementById('roleGuard');
 const form = document.getElementById('addItemForm');

 // case-insensitive role check
 const roles = (me && (Array.isArray(me.Roles) || Array.isArray(me.roles))) ? (me.Roles || me.roles) : [];
 const rolesLower = roles.map(r => String(r).toLowerCase());
 const hasAccess = rolesLower.includes('admin') || rolesLower.includes('worker');

 if (!hasAccess) {
 if (guard) guard.style.display = 'block';
 if (form) form.style.display = 'none';
 document.getElementById('addPanel').classList.add('disabled');
 } else {
 if (guard) guard.style.display = 'none';
 if (form) form.style.display = 'block';
 document.getElementById('addPanel').classList.remove('disabled');
 }
 }

 document.getElementById('type').addEventListener('change', e => {
 const type = e.target.value;
 populateSizesForType(type);
 });

 document.getElementById('size').addEventListener('change', onSizeChanged);

 document.getElementById('addItemForm').addEventListener('submit', async e => {
 e.preventDefault();
 const msg = document.getElementById('msg');
 msg.className = 'msg';
 msg.textContent = 'Dodawanie...';
 try {
 const dto = toDto();
 const result = await postJson(`${apiBase}/api/equipment/add`, dto);
 msg.className = 'msg success';
 msg.textContent = `✅ Dodano: ${result.Type ?? dto.Type} ${result.Size ?? dto.Size}. Ilość: ${result.Quantity ?? dto.Quantity}`;
 e.target.reset();
 const items = await getAvailability();
 buildAvailabilityMap(items);
 document.getElementById('size').disabled = true;
 document.getElementById('size').innerHTML = '<option value="">Najpierw wybierz typ</option>';
 } catch (err) {
 msg.className = 'msg error';
 msg.textContent = '❌ Błąd: ' + (err.message || err);
 }
 });

 document.getElementById('btnDelete').addEventListener('click', async () => {
 const msg = document.getElementById('msg');
 msg.className = 'msg';
 msg.textContent = 'Usuwanie...';
 try {
 const dto = toDto();
 if (!dto.Type || !dto.Size) throw new Error('Wybierz typ i rozmiar');
 const sizeSelect = document.getElementById('size');
 const opt = sizeSelect.selectedOptions[0];
 const available = opt ? parseInt(opt.dataset.available) : NaN;
 const qty = parseInt(document.getElementById('quantity').value) ||1;
 if (Number.isFinite(available) && available <=0) { throw new Error('Brak dostępnych przedmiotów do usunięcia.'); }
 if (Number.isFinite(available) && qty > available) { throw new Error(`Nie można usunąć więcej niż dostępne: ${available}`); }
 const result = await deleteJson(`${apiBase}/api/equipment/delete`, dto);
 msg.className = 'msg success';
 msg.textContent = `🗑️ Usunięto: ${dto.Type} ${dto.Size}. Usunięto: ${result.Deleted ??0} Pozostało: ${result.Remaining ?? ''}`;
 const items = await getAvailability();
 buildAvailabilityMap(items);
 } catch (err) {
 msg.className = 'msg error';
 msg.textContent = '❌ Błąd usuwania: ' + (err.message || err);
 }
 });

 (async function init(){
 await ensureRoles();
 const items = await getAvailability();
 buildAvailabilityMap(items);
 })();
 })();
 </script>
}