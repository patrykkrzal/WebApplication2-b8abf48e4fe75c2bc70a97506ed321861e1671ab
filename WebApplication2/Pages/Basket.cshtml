@page "/Basket.html"
@{
 ViewData["Title"] = "Koszyk";
}
<h1 class="winter-title">🧺 Koszyk</h1>
<div id="basketItems" class="contact-info"></div>
<div class="block-actions">
 <button class="winter-button" id="clearBasket">Wyczyść koszyk</button>
</div>
<div class="form-box">
 <label>
 Liczba dni wypożyczenia
 <input type="number" id="rentDays" min="1" value="1" />
 </label>
 <div class="contact-item">
 <strong>Suma podstawowa</strong>
 <div class="contact-value" id="baseTotal">0 zł</div>
 </div>
 <div class="contact-item">
 <strong>Łączna zniżka</strong>
 <div class="contact-value" id="discountPct">0%</div>
 </div>
 <div class="contact-item">
 <strong>Suma z dniami i zniżką</strong>
 <div class="contact-value" id="finalTotal">0 zł</div>
 </div>
 <div class="contact-item warn" id="stockWarning" style="display:none"></div>
 <div class="block-actions">
 <button class="winter-button" id="placeOrder" data-show-when-auth="true">Złóż zamówienie</button>
 </div>
</div>

@section Scripts {
<script>
// Cennik fallback (gdy brak Price w koszyku)
const priceMap = {
 Skis: { Small:120, Medium:130, Large:140 },
 Helmet: { Any:35, Universal:35 },
 Gloves: { Small:15, Medium:15, Large:15 },
 Poles: { Any:22 },
 Snowboard: { Any:160 },
 Goggles: { Any:55, Universal:55 }
};

// live lookup filled from API availability (UnitPrice)
let priceLookup = {}; // priceLookup[type][size] = number

async function loadPricesFromApi() {
 try {
 const res = await fetch('/api/equipment/availability', { credentials: 'include' });
 if (!res.ok) return;
 const list = await res.json();
 priceLookup = {};
 list.forEach(p => {
 const t = String(p.Type || p.type || '').trim();
 const s = String(p.Size || p.size || '').trim();
 // prefer UnitPrice
 const unit = Number(p.UnitPrice ?? p.unitPrice ?? p.UnitPrice ?? p.UnitPrice ?? p.UnitPrice);
 if (!t) return;
 priceLookup[t] = priceLookup[t] || {};
 priceLookup[t][s] = Number.isFinite(unit) && unit >0 ? unit : (Number.isFinite(p.Price) ? p.Price : (Number.isFinite(p.price) ? p.price : undefined));
 });
 } catch (e) {
 // ignore
 }
}

function readBasketFromStorage() {
 try {
 const raw = localStorage.getItem('basket');
 if (!raw) return [];
 return JSON.parse(raw);
 } catch (e) {
 // corrupted storage - remove and recover
 console.warn('Corrupted basket in localStorage, resetting.', e);
 localStorage.removeItem('basket');
 return [];
 }
}

let basket = readBasketFromStorage();

const qs = sel => document.querySelector(sel);

const qty = i => {
 const q = Number(i.quantity || i.Qty || i.qty || i.Quantity);
 return (!Number.isFinite(q) || q <=0) ?1 : q;
};

const name = i =>
 i.name || i.Name || [i.Type || i.type, i.Size || i.size].filter(Boolean).join(' ');

const price = i => {
 const p = Number(i.Price ?? i.price);
 if (Number.isFinite(p) && p >0) return p;

 const t = (i.Type ?? i.type);
 const s = (i.Size ?? i.size);
 if (t && priceLookup[t]) {
 // exact size
 if (s && priceLookup[t][s] !== undefined) return priceLookup[t][s];
 // Any / Universal
 if (priceLookup[t]['Any'] !== undefined) return priceLookup[t]['Any'];
 if (priceLookup[t]['Universal'] !== undefined) return priceLookup[t]['Universal'];
 }

 const tm = priceMap[(i.Type ?? i.type)];
 if (!tm) return 0;
 const ss = (i.Size ?? i.size);
 return (ss && tm[ss] !== undefined) ? tm[ss] : (tm.Any ||0);
};

const baseItemsTotal = () =>
 basket.reduce((s, i) => s + price(i) * qty(i),0);

const itemsCount = () =>
 basket.reduce((s, i) => s + qty(i),0);

const getDays = () =>
 Math.max(1, parseInt(String(qs('#rentDays').value).replace(',', '.'),10) ||1);

const itemsDetail = () =>
 basket.map(i => ({
 Type: (i.Type || i.type || '').toString(),
 Size: (i.Size || i.size || '').toString(),
 Quantity: qty(i),
 EquipmentIds: Array.isArray(i.EquipmentIds || i.equipmentIds)
 ? (i.EquipmentIds || i.equipmentIds)
 : []
 }));

function save() {
 localStorage.setItem('basket', JSON.stringify(basket));
}

function renderBasket() {
 const el = qs('#basketItems');

 if (!basket.length) {
 el.innerHTML = '<div class="contact-item">Koszyk jest pusty.</div>';
 } else {
 el.innerHTML = basket
 .map(i =>
 `<div class="contact-item">
 <strong>${name(i)} × ${qty(i)}</strong>
 <div class="contact-value">${(price(i) * qty(i)).toFixed(2)} zł</div>
 </div>`
 )
 .join('');
 }

 const baseBeforeDiscount = baseItemsTotal() * getDays();
 qs('#baseTotal').textContent = baseBeforeDiscount.toFixed(2) + ' zł';

 preview();
}

async function preview() {
 const warn = qs('#stockWarning');
 warn.style.display = 'none';
 warn.textContent = '';

 try {
 const res = await fetch('/api/orders/preview', {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 credentials: 'include',
 body: JSON.stringify({
 BasePrice: Number(baseItemsTotal().toFixed(2)),
 Days: getDays(),
 ItemsCount: itemsCount(),
 ItemsDetail: itemsDetail()
 })
 });

 if (!res.ok) throw new Error(await res.text());

 const d = await res.json();
 console.debug('preview response', d);
 // normalize discount: API may return fraction (0.2) or percent (20)
 let pct = Number(d.DiscountPct) ||0;
 if (pct >1) pct = pct /100;
 const final = Number(d.Price) ||0;

 qs('#discountPct').textContent = Math.round(pct *100) + '%';
 qs('#finalTotal').textContent = final.toFixed(2) + ' zł';

 const placeBtn = qs('#placeOrder');

 if (d.Error) {
 placeBtn.disabled = true;
 warn.style.display = 'block';
 warn.textContent = d.Error;
 } else {
 placeBtn.disabled = false;
 }
 } catch (e) {
 console.error('preview error', e);
 }
}

async function placeOrder() {
 try {
 const items = basket.map(i => `${name(i)} x ${qty(i)}`);

 const res = await fetch('/api/orders', {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 credentials: 'include',
 body: JSON.stringify({
 Items: items,
 BasePrice: Number(baseItemsTotal().toFixed(2)),
 Days: getDays(),
 ItemsCount: itemsCount(),
 ItemsDetail: itemsDetail()
 })
 });

 if (!res.ok) {
 const txt = await res.text();
 throw new Error(txt || 'Nie można złożyć zamówienia');
 }

 const d = await res.json();
 console.debug('create response', d);
 // normalize discount returned
 let pct = Number(d.DiscountPct) ||0;
 if (pct >1) pct = pct /100;

 alert(
 `Cena: ${(Number(d.Price) ||0).toFixed(2)} zł za ${getDays()} dni, zniżka: ${Math.round(pct *100)}%`
 );

 // Debug: fetch created order and pending/issued lists to verify backend state
 try {
 if (d && d.OrderId) {
 const r1 = await fetch(`/api/orders/report?id=${encodeURIComponent(d.OrderId)}`, { credentials: 'include' });
 const rep = r1.ok ? await r1.json() : await r1.text();
 console.debug('fetched created order by id', rep);
 }
 const p = await fetch('/api/orders/pending', { credentials: 'include' });
 const pending = p.ok ? await p.json() : null;
 console.debug('pending list after create', pending);
 const i = await fetch('/api/orders/issued', { credentials: 'include' });
 const issued = i.ok ? await i.json() : null;
 console.debug('issued list after create', issued);
 } catch (ex) {
 console.error('post-create debug fetch failed', ex);
 }

 localStorage.removeItem('basket');
 basket.length =0;

 renderBasket();
 } catch (e) {
 alert('Błąd zamówienia: ' + e.message);
 }
}

// attach listeners after DOM is ready
document.addEventListener('DOMContentLoaded', async () => { 
 await loadPricesFromApi(); 
 // reload basket from storage in case it was modified elsewhere
 basket = readBasketFromStorage();
 renderBasket();
 const clearBtn = qs('#clearBasket'); if (clearBtn) clearBtn.addEventListener('click', () => { localStorage.removeItem('basket'); basket.length =0; renderBasket(); });
 const placeBtn = qs('#placeOrder'); if (placeBtn) placeBtn.addEventListener('click', placeOrder);
 const rentDaysEl = qs('#rentDays'); if (rentDaysEl) rentDaysEl.addEventListener('input', () => renderBasket());
});

// update UI when storage changes (another tab/page updated the basket)
window.addEventListener('storage', (e) => {
 if (e.key === 'basket') {
 basket = readBasketFromStorage();
 renderBasket();
 }
});
</script>
}