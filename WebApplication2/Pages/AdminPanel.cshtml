@page "/AdminPanel.html"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@{
 ViewData["Title"] = "Panel administratora";
}

<style>
 .admin-grid {
 display: grid;
 gap:1rem;
 }

 .two-col {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
 gap: .75rem;
 }

 .msg { margin-top: .5rem; font-size: .95rem; }
 .msg.error { color: #ff6b6b; }
 .msg.success { color: #2ecc71; }

 .logs-box { margin-top:1rem; }
 .logs-item { padding: .45rem .6rem; border-bottom:1px solid rgba(255,255,255,.15); }
 .logs-item .lvl { font-weight:700; margin-right: .4rem; }

 .delete-box { margin-top:1.2rem; }

 /* Price manager table */
 .prices-box { margin-top: .8rem; }
 .prices-table { width:100%; border-collapse: collapse; }
 .prices-table th, .prices-table td { padding:8px10px; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; }
 .prices-table th { font-weight:700; }
 .price-row input[type="number"] { width:120px; }
 .price-actions { display:flex; gap:8px; }
</style>

<div class="content-section">
 <div class="frost-effect admin-grid">
 <h1 class="winter-title">🛠️ Panel administratora</h1>

 <!-- Dodawanie pracownika -->
 <div class="form-box">
 <h2 class="section-title" style="text-align:center;">👷 Dodaj pracownika</h2>
 <form id="workerForm" novalidate>
 <div class="two-col">
 <label>Imię<input type="text" name="FirstName" required class="form-control" /></label>
 <label>Nazwisko<input type="text" name="LastName" required class="form-control" /></label>
 <label>Email<input type="email" name="Email" required class="form-control" /></label>
 <label>Telefon (9 cyfr)<input type="text" name="PhoneNumber" maxlength="9" pattern="\d{9}" required class="form-control" /></label>
 <label>Stanowisko (Job_Title)<input type="text" name="Job_Title" required class="form-control" /></label>
 <label>Hasło (min.6)<input type="password" name="Password" minlength="6" required class="form-control" /></label>
 <label>Adres (opcjonalnie)<input type="text" name="Address" class="form-control" /></label>
 <label>Dni pracy<input type="text" name="Working_Days" class="form-control" /></label>
 <label>Start pracy<input type="time" name="WorkStart" value="08:00" required class="form-control" /></label>
 <label>Koniec pracy<input type="time" name="WorkEnd" value="16:00" required class="form-control" /></label>
 </div>
 <div class="block-actions" style="margin-top:.5rem;">
 <button class="winter-button" type="submit">➕ Utwórz pracownika</button>
 </div>
 <div id="workerMsg" class="msg"></div>
 </form>
 </div>

 <!-- Usuwanie użytkownika -->
 <div class="form-box delete-box">
 <h2 class="section-title" style="text-align:center;">🗑️ Usuń użytkownika / pracownika</h2>
 <form id="deleteForm" novalidate>
 <label>Email do usunięcia<input type="email" name="DelEmail" id="delEmail" required placeholder="np. jan@firma.com" class="form-control" /></label>
 <div class="block-actions" style="margin-top:.6rem;">
 <button class="winter-button danger" type="submit">🗑️ Usuń</button>
 </div>
 <div id="deleteMsg" class="msg"></div>
 </form>
 </div>

 <!-- Price management -->
 <div class="form-box prices-box">
 <h2 class="section-title" style="text-align:center;">💲 Cennik (globalne ceny według typu i rozmiaru)</h2>
 <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
 <label style="display:flex; gap:8px; align-items:center;">
 Typ
 <select id="priceType" class="form-select">
 <option value="">-- wybierz --</option>
 <option>Snowboard</option>
 <option>Gloves</option>
 <option>Poles</option>
 <option>Helmet</option>
 <option>Skis</option>
 <option>Goggles</option>
 </select>
 </label>
 <label style="display:flex; gap:8px; align-items:center;">
 Rozmiar
 <select id="priceSize" class="form-select">
 <option value="">-- wybierz --</option>
 <option>Universal</option>
 <option>Small</option>
 <option>Medium</option>
 <option>Large</option>
 <option>Xl</option>
 </select>
 </label>
 <label style="display:flex; gap:8px; align-items:center;">
 Cena
 <input id="priceValue" type="number" step="0.01" min="0" class="form-control" style="width:120px;" />
 </label>
 <button id="priceSave" class="submit-btn">💾 Zapisz</button>
 <button id="priceReload" class="winter-button">🔄 Odśwież</button>
 </div>
 <div id="pricesList"></div>
 <div id="pricesMsg" class="msg"></div>
 </div>

 </div>
</div>

@section Scripts {
<script>
(async function () {
 // -------------------
 // Formularz dodawania pracownika
 // -------------------
 document.getElementById('workerForm').addEventListener('submit', async (e) => {
 e.preventDefault();
 const msg = document.getElementById('workerMsg');
 msg.className = 'msg';
 msg.textContent = 'Tworzenie pracownika...';

 const formData = Object.fromEntries(new FormData(e.target));
 const payload = {
 FirstName: formData.FirstName?.trim(),
 LastName: formData.LastName?.trim(),
 Email: formData.Email?.trim(),
 PhoneNumber: formData.PhoneNumber?.trim(),
 Address: formData.Address?.trim() || null,
 WorkStart: formData.WorkStart,
 WorkEnd: formData.WorkEnd,
 Working_Days: formData.Working_Days?.trim() || null,
 Job_Title: formData.Job_Title?.trim(),
 Password: formData.Password
 };

 try {
 const res = await fetch('/api/Workers', {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 credentials: 'include',
 body: JSON.stringify(payload)
 });
 if (!res.ok) throw new Error(await res.text());
 const data = await res.json();

 msg.className = 'msg success';
 msg.textContent = '✅ Utworzono pracownika';
 e.target.reset();
 } catch (err) {
 msg.className = 'msg error';
 msg.textContent = '❌ Wystąpił błąd';
 }
 });

 // -------------------
 // Formularz usuwania pracownika
 // -------------------
 document.getElementById('deleteForm').addEventListener('submit', async (e) => {
 e.preventDefault();
 const delMsg = document.getElementById('deleteMsg');
 delMsg.className = 'msg';
 delMsg.textContent = 'Usuwanie...';

 const email = document.getElementById('delEmail').value.trim();
 if (!email) {
 delMsg.className = 'msg error';
 delMsg.textContent = 'Podaj email';
 return;
 }

 try {
 const res = await fetch('/api/Workers/' + encodeURIComponent(email), {
 method: 'DELETE',
 credentials: 'include'
 });
 if (!res.ok) throw new Error(await res.text());
 const data = await res.json().catch(() => ({ Email: email }));

 delMsg.className = 'msg success';
 delMsg.textContent = '🗑️ Usunięto: ' + (data.Email || email);
 e.target.reset();
 } catch (err) {
 delMsg.className = 'msg error';
 delMsg.textContent = '❌ Wystąpił błąd';
 }
 });

 // -------------------
 // Price management
 // -------------------
 const priceTypeEl = document.getElementById('priceType');
 const priceSizeEl = document.getElementById('priceSize');
 const priceValueEl = document.getElementById('priceValue');
 const pricesListEl = document.getElementById('pricesList');
 const pricesMsgEl = document.getElementById('pricesMsg');

 async function loadPrices() {
 pricesMsgEl.textContent = 'Ładowanie...';
 try {
 const res = await fetch('/api/equipment/prices', { credentials: 'include' });
 if (!res.ok) throw new Error(await res.text());
 const list = await res.json();
 renderPrices(list);
 pricesMsgEl.textContent = '';
 } catch (err) {
 pricesMsgEl.className = 'msg error';
 pricesMsgEl.textContent = 'Błąd ładowania: ' + (err.message || err);
 }
 }

 function renderPrices(list) {
 pricesListEl.innerHTML = '';
 if (!list || !list.length) { pricesListEl.textContent = 'Brak wpisów.'; return; }
 const table = document.createElement('table'); table.className = 'prices-table';
 const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Typ</th><th>Rozmiar</th><th>Cena</th><th>Note</th><th></th></tr>';
 table.appendChild(thead);
 const tbody = document.createElement('tbody');
 list.forEach(p => {
 const tr = document.createElement('tr');
 tr.innerHTML = `<td>${p.Type}</td><td>${p.Size}</td><td><input type="number" step="0.01" value="${p.Price}" class="price-input" /></td><td>${p.Note ?? ''}</td>`;
 const btnTd = document.createElement('td');
 const saveBtn = document.createElement('button'); saveBtn.className = 'winter-button'; saveBtn.textContent = '💾';
 const delBtn = document.createElement('button'); delBtn.className = 'winter-button'; delBtn.textContent = '🗑️';
 const removeOfferBtn = document.createElement('button'); removeOfferBtn.className = 'winter-button danger'; removeOfferBtn.textContent = '❌';
 btnTd.appendChild(saveBtn); btnTd.appendChild(delBtn); btnTd.appendChild(removeOfferBtn);
 tr.appendChild(btnTd);
 tbody.appendChild(tr);

 saveBtn.onclick = async () => {
 const newPrice = parseFloat(tr.querySelector('.price-input').value);
 try {
 const payload = { Type: p.Type, Size: p.Size, Price: newPrice };
 const r = await fetch('/api/equipment/prices', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), credentials: 'include' });
 if (!r.ok) throw new Error(await r.text());
 await loadPrices();
 } catch (err) { }
 };

 delBtn.onclick = async () => {
 if (!confirm(`Usuń cenę dla ${p.Type} ${p.Size}?`)) return;
 try {
 const payload = { Type: p.Type, Size: p.Size };
 const r = await fetch('/api/equipment/prices', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), credentials: 'include' });
 if (!r.ok) throw new Error(await r.text());
 await loadPrices();
 } catch (err) { }
 };

 // Remove full offer: delete unreserved equipment items and the price entry
 removeOfferBtn.onclick = async () => {
 if (!confirm(`Czy na pewno chcesz usunąć pozycję z oferty ${p.Type} ${p.Size}?`)) return;
 try {
 const payload = { Type: p.Type, Size: p.Size };
 const r = await fetch('/api/equipment/prices/remove-offer', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), credentials: 'include' });
 if (!r.ok) throw new Error(await r.text());
 const data = await r.json().catch(() => ({}));
 await loadPrices();
 } catch (err) { }
 };
 });
 table.appendChild(tbody);
 pricesListEl.appendChild(table);
 }

 document.getElementById('priceSave').addEventListener('click', async (e) => {
 e.preventDefault();
 const type = priceTypeEl.value;
 const size = priceSizeEl.value;
 const price = parseFloat(priceValueEl.value);
 if (!type || !size || !Number.isFinite(price)) { pricesMsgEl.className = 'msg error'; pricesMsgEl.textContent = 'Wypełnij wszystkie pola (typ/rozmiar/cena)'; return; }
 try {
 const payload = { Type: type, Size: size, Price: price };
 const res = await fetch('/api/equipment/prices', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), credentials: 'include' });
 if (!res.ok) throw new Error(await res.text());
 pricesMsgEl.className = 'msg success'; pricesMsgEl.textContent = 'Zapisano.';
 await loadPrices();
 } catch (err) {
 pricesMsgEl.className = 'msg error'; pricesMsgEl.textContent = 'Błąd zapisu: ' + (err.message || err);
 }
 });

 document.getElementById('priceReload').addEventListener('click', async (e) => { e.preventDefault(); await loadPrices(); });

 // -------------------
 // Init
 // -------------------
 await loadPrices();
})();
</script>
}